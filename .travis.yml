language: java
jdk:
- openjdk8
install: true
addons:
  sonarcloud:
    organization: xm-online
    token:
      secure: vTf6MLhCgjmg0CcpAqcOkcMk9ks/z2yeGfH7kexXgSld0usCw8HJlV1U4XJ0sJkTugwjw2aEOgbZvKqh8cpzzX6bkfzLJrKjdneRmr8xceOZ3oN6Z4mafGERgJSS6WnVa0TNws083DgZ+WsPtfhx/wPH43kjvxH8+3eLZC4x8fGfyIBa6uJrZPIzThiMbGsq6PzK22UzeIB3QPeHAH2cP6pUYtouYpQzrwehT1S7WY+I2WGv/DMm+aqZSXgHHJhWh/uP0I9Rn9oxDKX0pEiyjIdtAKFfYLrjQ1RwzFIbWLyUVEGM7F2zaDDd8f21FbJRhujhvEjGaO0U1etlY2v2ar1mHosjXe3AuJ3CaanFFmJ1CQfj7Ch9Ad4GnCEDIu9+elczUF0AMMzex1qC/CVyfHFSHcOGcjgFhxlTGNhsI1XUGOLa2k7sXm2EgIhOrUpAyL6t7NWkFY43Ybz2NZJrlru8UKdmwK25KLXVyqVisw1SOdKa9Qh5ZxdmZBM1bEU3p8hL/TVAZfKrMtEcU9Ysm/szKovbpSj02pUcHkTp/1g0GoPGi8KJUaauqOdfDGPIOZuhtUuUSdsuOqPdktcNPZvIYWASN3SPI376ljBvT100UuPKhwnO7GXMRXhyLAYj10Pp5M485gRid2Ty2ja+Qkh44t2cAIeWYhwRXTezz5w=
    branches:
    - master

script:
  - set -e
  - "./gradlew --no-daemon --refresh-dependencies clean check test"
  - "./gradlew -x test -Pprod --no-daemon bootWar"
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - export DOCKER_REPO=$(echo  -n $TRAVIS_REPO_SLUG | sed -e 's/^xm-online\//xmonline\//g')
  - export IMAGE_BRANCH=$(echo -n $TRAVIS_BRANCH | sed -e 's/\//-/g')
  - export PROJECT_VERSION=$(./gradlew -q  getProjectVersion)
  - if [ "$IMAGE_BRANCH" == "master" ]; 
    then 
        export SONAR_PK=$(echo  -n $TRAVIS_REPO_SLUG | sed -e 's/\//:/g');
        ./gradlew -x test --no-daemon sonarqube -Dsonar.projectKey="$SONAR_PK"
        -Dsonar.projectName="$SONAR_PK" -Dsonar.java.binaries="." -Dsonar.projectVersion="$IMAGE_BRANCH";
        TAGS="$PROJECT_VERSION $PROJECT_VERSION-$TRAVIS_BUILD_NUMBER $(echo $PROJECT_VERSION | awk -F '.' '{printf $1"."$2" "$1}') latest";
    else
        TAGS="$IMAGE_BRANCH $IMAGE_BRANCH-$TRAVIS_BUILD_NUMBER";
    fi
  - docker build -t app-docker-img --label commit_id="$TRAVIS_COMMIT" --label commit_message="$TRAVIS_COMMIT_MESSAGE" -f src/main/docker/Dockerfile .
  - for TAG in $TAGS;
    do
        docker tag app-docker-img $DOCKER_REPO:$TAG;
        docker push $DOCKER_REPO:$TAG;
    done
 
cache:
  directories:
  - "~/.gradle"
  - "~/.m2"

env:
  global:
  - secure: vKDME+RnHw3IDwNUZ14/R4jaT+tvaMppLZPTOeRZN00J34DKIGqzUJJgd60u3j0IUKNAe0D7+WrKHdwA+1ZVEOJG8NWWJpsplJvrpQGG/xrHpxKcHl1Poq3AbuvDPKvdEb6qjbP1a0+iGUrohF+SFYMdujg9t8IIVSvzWHhlBlTjJovC5RqVPvW1EFfyL5wzQzvr5lEckXlMMk9b3nIB+0SywBZM4ePdUbNF2uow4jozwkhXHq05qJt/l4pgaVswFy/H5uKuS9c2h3aJACrjxMZvvXi07wkhlJyYfk3sJR7hasYHOdhSupinZAlE8S1UR5UEGY7TA8YLsmy8wwq2tvvDytqTNuZyFlwBy6flCyMg6x7rBEYLsDpzgSptuOE2K+UivfQn5uXCxDtccjZ7d+L9VU8cs7VrgnxKJYFVkfupjE/WDrefp+Zk3nsfNwA51Ove+qxpF9L2htRS/7M6nHP1kIkXVsKwXrF/KuwXk3+qIPQMdImUvnZpokUJW4AFVQ/s1QGasna5Oh0aTOCh8jL55XUEWe7feFaFrcxO2JxWiK3YRT29LwLTeuR5AZV4s+dYiMHczCTYOJyDkEzIgmizKXf40696reDDcJ0FV0QbAFnS8a+btOcrb/DInzrNRnZCXN9xiiM8HP5FY9NZdq1Jj70K6LizVvG+uKzDvJg=
  - secure: qwod3r6FtI93wUHJvz/J4+7BMoAHNznl2M8J0L6xCA4RK0YtWUSNPd5HmGMDuRiQhFvLuyiEETM6OGYTWyDNAuEydqfGY6V+nZGPCGQSfoZ/VSvaV0hKUuLo+DTlGVrAphyuhj1sB9Xcu9LlBN+7BmZN7e8GIBkI03tiy6EdqDMkYYbHpEW3CEw6IzTDh8EltmWWL8DNd8k5Mp1K1PGqLvDp+RthNX/+rTSWis7Lcdz4BFEy7aJr46qT/9VdmnXZWExQdsnK8aCVSMFip1NjuomDjzTmyIngQqHDBHJxuLoy7ujvHjESsri6PgSAYUlgW3I+e6M3cC1uKuQxskmSd9F9NvWMBnJjqtLe/zEZ+4R3OFusKpleKne09Lb7x5MOoBhJOsyxiBN/A3Tjajrvca2wy5JPI+gcTTbNWfN2FcSEaSA3XnLs73DDGmZqoT9gW80jueTLhLAE2icVCU3wGpKTYO8G4NANrqvlHwcV4dufvfttFGECyMiTl3XscS7DiHHK5kjvB4pubygbXbmsGsY+jDM1nUXXhD9vaLCm8mt7qBzCtqylm/QscmGD02hedqWo+aZ4QJYpXEkLFecgiDiv3fY5YOYnBzH+AxzD7k665YokL3kdlBT6EaCv25QiB3JBpuDWS0hnOc5USDwZhAsxSqhLm6OeyH2a4f5y0HQ=

notifications:
  slack:
    rooms:
      secure: eHvxMZJsCw0vBFWkSsL8YIwam4b43HppJ2m9I+QhW6v/oG7LdxxKeDjpTOn7ramXZxxGZEqibA5QjilMqnraPzHy3lqo7x8+LQXMN5sfDI/B6TZmWZ5r2oEr384L3p02xLwalA2I18xjPwWEQFdERL4wzJNvvXIki/T3X3GGi4pglAfyM6gLTsP0H0fA4WSj8e6Z9Ap7B1UD3tcwKk6+9vbJUEmc+HTx6my317hkmbi/I6mXZb9p63q2yvKnjEaU8vlULYls3gPxQDrozLbDMN5dFATS2p5mqrJVNY8r3gcJb0l38eFVzl09YWiNTfEWgT9k1zi3O9FF8GG2VyJQv8i4LGcwZE1Wrdd1iakWugXlHTnROD1wjmgIwN7f0UBX6VXztJ92NXqKus5CkfBioksi45uHLJJFbnz8vMXQCCkidW/VVg91GitMjN1s16JcXbBbQMShpmZ07Jub+zn7pIy2y6xHGQSRe3Z2wf7rI8VjqyH3OnuGT/HLLEaslGWuPTSaswoO1HljG61ttjoPk1czfeABeNQGzmzYgPEVENBRhjr46AR95Thyjbo803B/fsk/uFDVAVrLZZAveqQvl7gNcewLyRetDWKm95GM30Sl8vZkhHXJc9OIHu17QOnsjTKaBa2J6CVTT+E3f6Fc5Pyr4FxfZN/FK99MDf6GWFg=
