language: java
jdk:
  - openjdk11
install: true
addons:
  sonarcloud:
    organization: xm-online
    token:
      secure: ey87lQ1+0vw5Efyf/1A4+ASIRyaZ+nFPw1/AtrPcbubqiCZC9FV16DdVxjymxNCA46alDNAWZWFiINGvFCnK/bA439/43YuoLf7mfiYsWF9wnn0o+FYAT9ndziLKyRwmcjOKFlzR3gIkXP7f3qHRbE0tfcbriN1/93Bc+rx1H0+aqCtjYmngchiP6Dnzj7a293myUleQUEp+c6mqkjza8/w8WfLLAlUC91tArLmOkdP4uqxvnWQ091KaVodXsUUQNKIRtlciBUp6Y0nZpXLeDS8LLo+zWZnfK1xaKk028qYqq0sRpE9SQy6baoaf170yAWfO7gasQ3ElokUkjBLBdgwzRf42C0vWUuhACY54Y3+ofxCsZpoyIWdsdeYwvEmAR+4FkEOSRvmY9DIKvzJs/YwJc/HeAlz4UuedEdf5XKwIV3a/EwMN/axRWOnzd0lEmfFwLIairHW56Xmp9CN0Iq5OOoRUWlI5qSdyQfvsPg8DuDmOSTjL2v9Rc8yCCNj+hJbBVC7ku79ppqSABzzx0cZke2li7zb8Eg7LkuGls63F3/iwhSTEQOCWXo7rGMUbl5Avh/QAZZRH7MiVzZ/DiXxtcP4Ko7SH21aDojWQxpiYfTDPpeXnovfFX5yx9X/mgNZjkPvNGCENnkHbrureutrl+zrd7+9uQQUID07h9NI=
    branches:
      - master

script:
  - set -e
  - "./gradlew --no-daemon --refresh-dependencies clean check test"
  - "./gradlew -x test -Pprod --no-daemon bootWar"
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - export DOCKER_REPO=$(echo  -n $TRAVIS_REPO_SLUG | sed -e 's/^xm-online\//xmonline\//g')
  - export IMAGE_BRANCH=$(echo -n $TRAVIS_BRANCH | sed -e 's/\//-/g')
  - export PROJECT_VERSION="$IMAGE_BRANCH"
  - if [ "$IMAGE_BRANCH" == "master" ]; 
    then 
        PROJECT_VERSION=$(./gradlew -q  getProjectVersion);
        export SONAR_PK=$(echo  -n $TRAVIS_REPO_SLUG | sed -e 's/\//:/g');
        ./gradlew -x test --no-daemon sonarqube -Dsonar.projectKey="$SONAR_PK"
        -Dsonar.projectName="$SONAR_PK" -Dsonar.java.binaries="." -Dsonar.projectVersion="$IMAGE_BRANCH";
        TAGS="$PROJECT_VERSION $PROJECT_VERSION-$TRAVIS_BUILD_NUMBER $(echo $PROJECT_VERSION | awk -F '.' '{printf $1"."$2" "$1}') latest";
    else
        TAGS="$IMAGE_BRANCH $IMAGE_BRANCH-$TRAVIS_BUILD_NUMBER";
    fi
  - docker build -t app-docker-img --label commit_id="$TRAVIS_COMMIT" --label version="$PROJECT_VERSION" --label build_number="$TRAVIS_BUILD_NUMBER" --label build_url="$TRAVIS_BUILD_WEB_URL" --label git_url="$TRAVIS_REPO_SLUG" --label commit_message="$TRAVIS_COMMIT_MESSAGE" -f src/main/docker/Dockerfile .
  - for TAG in $TAGS;
    do
        docker tag app-docker-img $DOCKER_REPO:$TAG;
        docker push $DOCKER_REPO:$TAG;
    done

cache:
  directories:
    - "~/.gradle"
    - "~/.m2"
env:
  global:
    - secure: ODiYIYqpQa/Ijj1T5tBDf1Jzfvq5MzAxY9PA/cfUXnA6AmpF8LWMC3FPuCKrXssCRCmpodRtHBA03lIXny6tNBrLi3pqmrIhq2XbpsNIqHzn5wJIHWIaZNagqVFypwQxou/FJpy22+weQKvu1rrVjh1AIMbpyGFgKZjlyke/pYkryAUyYyxLSZ+IXPCLpJTrUjDXMEWp3YtZKlIjTMrQrAD+tUvkny3WEG3rjwXsq1bKQDHduv6CM29CkkBAsBgK0cFZt25cPyXKhe9wEPqwFb5bt2sNV+RZm3J/PSWmyta4h3isyu6v1IeUyaSos0lYpy0ihEd6TXskJHnTJLC9M8sXCRNN6pjxTCLTWoOS5LGHzUc2BS0uZY/7+H3o4H/gwCIpcVKsEszrZU3VZRc4FFTr29hm6V8x+O5kdmrhShtNL1pV+yScc9RUIuRR+WVsRi437lhMIQkxOlApnc+kdtUpDQdNXqoAzH/oL4bxJMGK9NOWYRq/9Lx9+FHJHUOAAjJ09ySrWrJ6VDV89NC+CQqY8DLa70TOxlP2wYFeiJdFvf7JuyE8mQC3d6XOcnTOa7jyU69FHuAlP4EGeUblnFPA7oWxk26RXfGu1p5vZ53Q9LDAOWwGibD1uR2yGuUwZa0MFFX+kItMqRjAFSNJh3A7sVRIJhV4lZv2fDS0nFg=
    - secure: WIAnu6Z0bs7cwHM8kvme43Gnb195/OZ2neIipMMZnLxw90EYkwoLBQCKx2ziZXmgM9+7BK9WlmzUKB3NzN+8L5Ol6N/6G04KX5AL+/X33iuRcbCKgWU57rn2TpjfVWdDNqLMFA50RmIYUplG42lnXK9BysI3G992FUb7m6Cu4lekGfgt6e7KSVi/TP5oVB5UALEwvN0S2hyenwGKzYn6RA8wtgkmxcbbLDD1KvGUAjWB/lmzZvNuhFesDV4pyQxu1fox9Afr3VGzjGdJjNXV+41dfAL5CtFcvLJyW3VoK4b6sVSnRoP5mPlwoAMEJHR4Lb1K+HNk4rh2ok+kiNiSWU4nt3a9Re12OSvKIPL+/sFToT8VXaTY/Up1wOvpmnxyAp6GGH8dErNoi5uPHC96HlnCxWv44OWxsD29jn4U71SjFPiCcQCNIeELiEDS5dt0omwoYzX4SswouSamoCw1oalk9uPNOPyQHggZtYIpNa/8xvrZ1t7YQv9Icz1T6IztkdOE6HDEL3+VC94xpsv7VNXO8KfcbHooEZRSA9bpG3fPkCkZob3lQfVsqkuGlS3/BZwHJJk4kRUEinRayFRVQsLm2tiZU0F6hf+mqqp8zJ39dCM6eLZVZwMzkUsCLzvnGIjbFGMbN6HqDznevUvoxljFbYhrExM1pNAdoBTqQLc=

notifications:
  slack:
    rooms:
      secure: eHvxMZJsCw0vBFWkSsL8YIwam4b43HppJ2m9I+QhW6v/oG7LdxxKeDjpTOn7ramXZxxGZEqibA5QjilMqnraPzHy3lqo7x8+LQXMN5sfDI/B6TZmWZ5r2oEr384L3p02xLwalA2I18xjPwWEQFdERL4wzJNvvXIki/T3X3GGi4pglAfyM6gLTsP0H0fA4WSj8e6Z9Ap7B1UD3tcwKk6+9vbJUEmc+HTx6my317hkmbi/I6mXZb9p63q2yvKnjEaU8vlULYls3gPxQDrozLbDMN5dFATS2p5mqrJVNY8r3gcJb0l38eFVzl09YWiNTfEWgT9k1zi3O9FF8GG2VyJQv8i4LGcwZE1Wrdd1iakWugXlHTnROD1wjmgIwN7f0UBX6VXztJ92NXqKus5CkfBioksi45uHLJJFbnz8vMXQCCkidW/VVg91GitMjN1s16JcXbBbQMShpmZ07Jub+zn7pIy2y6xHGQSRe3Z2wf7rI8VjqyH3OnuGT/HLLEaslGWuPTSaswoO1HljG61ttjoPk1czfeABeNQGzmzYgPEVENBRhjr46AR95Thyjbo803B/fsk/uFDVAVrLZZAveqQvl7gNcewLyRetDWKm95GM30Sl8vZkhHXJc9OIHu17QOnsjTKaBa2J6CVTT+E3f6Fc5Pyr4FxfZN/FK99MDf6GWFg=
